<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
Â  Â  <title>AIéŸ³å£°å…¥åŠ›ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆUI (ãƒã‚¤ã‚¯/ãƒ†ã‚­ã‚¹ãƒˆä¸¡å¯¾å¿œç‰ˆ)</title>
Â  Â  <style>
Â  Â  Â  Â  body {
Â  Â  Â  margin: 0;
Â  Â  Â  Â  Â  Â  background: #0f0f0f;
Â  Â  Â  Â  Â  Â  font-family: 'Segoe UI', sans-serif;
Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  Â  Â  color: #fff;
Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â /* 1. æ³¢å½¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®èƒŒæ™¯ */
Â  Â  Â  Â  Â  Â  #waveCanvas {
Â  Â  Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  Â  Â  top: 0; left: 0;
Â  Â  Â  Â  Â  Â  Â  Â  width: 100vw;
Â  Â  Â  Â  Â  Â  Â  Â  height: 100vh;
Â  Â  Â  Â  Â  Â  Â  Â  z-index: 0;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  /* 2. UIã‚³ãƒ³ãƒ†ãƒŠã®èª¿æ•´ (ä¸‹éƒ¨ã«å›ºå®š) */
Â  Â  Â  Â  Â  Â  #ui {
Â  Â  Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  Â  Â  bottom: 5%;
Â  Â  Â  Â  Â  Â  Â  Â  left: 50%;
Â  Â  Â  Â  Â  Â  Â  Â  transform: translateX(-50%);
Â  Â  Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  Â  Â  gap: 1.5rem;
Â  Â  Â  Â  Â  Â  Â  Â  z-index: 10;
Â  Â  Â  Â  Â  Â  Â  Â  opacity: 1; /* åˆæœŸçŠ¶æ…‹ã‚’å¯è¦–ã« */
Â  Â  Â  Â  Â  Â  Â  Â  transition: opacity 0.5s; /* ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ */
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  /* 3. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¨ãƒªã‚¢ã®å®šç¾© */
Â  Â  Â  Â  Â  Â  #status-area {
Â  Â  Â  Â  Â  Â  Â  Â  padding: 15px 30px;
Â  Â  Â  Â  Â  Â  Â  Â  background: rgba(0, 0, 0, 0.5);
Â  Â  Â  Â  Â  Â  Â  Â  border-radius: 12px;
Â  Â  Â  Â  Â  Â  Â  Â  backdrop-filter: blur(5px);
Â  Â  Â  Â  Â  Â  Â  Â  box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
Â  Â  Â  Â  Â  Â  Â  Â  color: #00ffff;
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 1.2rem; /* ã‚µã‚¤ã‚ºã‚’èª¿æ•´ã—ã¦è¤‡æ•°è¡Œã«å¯¾å¿œ */
Â  Â  Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  Â  Â  min-height: 40px; 
Â  Â  Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  Â  Â  white-space: pre-line; /* è¤‡æ•°è¡Œè¡¨ç¤ºã‚’ã‚µãƒãƒ¼ãƒˆ */
Â  Â  Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  Â  Â  line-height: 1.4;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  /* 4. å…¥åŠ›ã¨ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
Â  Â  Â  Â  Â  Â  #input-controls {
Â  Â  Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  Â  Â  gap: 1rem;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  #messageInput {
Â  Â  Â  Â  Â  Â  Â  Â  width: 400px;
Â  Â  Â  Â  Â  Â  Â  Â  padding: 1rem;
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 1.2rem;
Â  Â  Â  Â  Â  Â  Â  Â  background: rgba(255, 255, 255, 0.05);
Â  Â  Â  Â  Â  Â  Â  Â  border: 1px solid rgba(0, 255, 255, 0.5);
Â  Â  Â  Â  Â  Â  Â  Â  color: #fff;
Â  Â  Â  Â  Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  Â  Â  Â  Â  backdrop-filter: blur(10px);
Â  Â  Â  Â  Â  Â  Â  Â  outline: none;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  #messageInput::placeholder {
Â  Â  Â  Â  Â  Â  Â  Â  color: rgba(255, 255, 255, 0.4);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  /* ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ç¶­æŒ */
Â  Â  Â  Â  Â  Â  #sendBtn {
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 1rem; 
Â  Â  Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  Â  Â  width: auto; 
Â  Â  Â  Â  Â  Â  Â  Â  padding: 1rem 2rem;
Â  Â  Â  Â  Â  Â  Â  Â  color: #0f0f0f;
Â  Â  Â  Â  Â  Â  Â  Â  background: #00ffff;
Â  Â  Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  Â  Â  backdrop-filter: blur(10px);
Â  Â  Â  Â  Â  Â  Â  Â  transition: background 0.3s;
Â  Â  Â  Â  Â  Â  Â  Â  box-shadow: 0 0 40px #00ffff;
Â  Â  Â  Â  Â  Â  Â  Â  font-weight: bold;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  #sendBtn:hover {
Â  Â  Â  Â  Â  Â  Â  Â  background: #33ffff;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  /* 5. èªè­˜çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ (Transcript) ã®ã‚¹ã‚¿ã‚¤ãƒ« */
Â  Â  Â  Â  Â  Â  #transcript {
Â  Â  Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  Â  Â  top: 50%;
Â  Â  Â  Â  Â  Â  Â  Â  left: 50%;
Â  Â  Â  Â  Â  Â  Â  Â  transform: translate(-50%, -50%);
Â  Â  Â  Â  Â  Â  Â  Â  color: #00ffaa;
Â  Â  Â  Â  Â  Â  Â  Â  font-size: 2.5rem;
Â  Â  Â  Â  Â  Â  Â  Â  font-weight: 300;
Â  Â  Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  Â  Â  max-width: 80vw;
Â  Â  Â  Â  Â  Â  Â  Â  pointer-events: none; 
Â  Â  Â  Â  Â  Â  Â  Â  z-index: 5;
Â  Â  Â  Â  Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  Â  Â  Â  Â  background: rgba(0, 0, 0, 0.3);
Â  Â  Â  Â  Â  Â  Â  Â  border-radius: 15px;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  /* 6. ã‚¿ãƒƒãƒ—æ¤œå‡ºã‚¨ãƒªã‚¢ (UIãƒˆã‚°ãƒ«ç”¨) */
Â  Â  Â  Â  Â  Â  #tapArea {
Â  Â  Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  Â  Â  top: 0;
Â  Â  Â  Â  Â  Â  Â  Â  left: 0;
Â  Â  Â  Â  Â  Â  Â  Â  width: 100vw;
Â  Â  Â  Â  Â  Â  Â  Â  height: 100vh;
Â  Â  Â  Â  Â  Â  Â  Â  z-index: 1; 
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  /* 7. å…¥åŠ›æ¬„ã®ç„¡åŠ¹åŒ–ã‚¹ã‚¿ã‚¤ãƒ« */
Â  Â  Â  Â  Â  Â  #messageInput:disabled {
Â  Â  Â  Â  Â  Â  Â  Â  cursor: not-allowed;
Â  Â  Â  Â  Â  Â  Â  Â  background: rgba(255, 255, 255, 0.02);
Â  Â  Â  Â  Â  Â  Â  Â  border-color: rgba(255, 0, 0, 0.3); /* èªè­˜ä¸­ã¯èµ¤ã£ã½ãã—ã¦è¦–è¦šçš„ã«ç„¡åŠ¹ã¨ç¤ºã™ */
Â  Â  Â  Â  Â  Â  Â  Â  color: rgba(255, 255, 255, 0.3);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  </style>
Â  Â  </head>
Â  Â  <body>
Â  Â  Â  Â  <canvas id="waveCanvas"></canvas>
Â  Â  Â  Â  
Â  Â  Â  Â  <div id="tapArea"></div>

Â  Â  Â  Â  <div id="transcript"></div> 
Â  Â  Â  Â  
Â  Â  Â  Â  <div id="ui">
Â  Â  Â  Â  Â  Â  <div id="status-area">
Â  Â  Â  Â  Â  Â  Â  Â  ã‚¤ãƒã‚¸ãƒŠãƒªãƒ¼ãƒŠãƒ³ãƒãƒ¼<br>
Â  Â  Â  Â  Â  Â  Â  Â  é€šç§°GAIã‚¤ãƒã•ã‚“AI<br>
Â  Â  Â  Â  Â  Â  Â  Â  AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆå¾…æ©Ÿä¸­...
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div id="input-controls">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="messageInput" placeholder="ã“ã“ã«æ–‡ç« ã‚’å…¥åŠ›ã™ã‚‹ã‹ã¾ãŸã¯ä½•ã‹è©±ã—ã¦ãã ã•ã„...." value="">
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  <button id="sendBtn">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ãƒã‚¤ã‚¯/AIã‚’<br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ãƒªã‚»ãƒƒãƒˆã™ã‚‹
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <script>
Â  Â  Â  Â  Â  Â  /* ---------- Canvasã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–¢é€£ ---------- */
Â  Â  Â  Â  const canvas = document.getElementById("waveCanvas");
Â  Â  Â  Â  const ctx = canvas.getContext("2d");
Â  Â  Â  Â  canvas.width = window.innerWidth;
Â  Â  Â  Â  canvas.height = window.innerHeight;

Â  Â  Â  Â  let bars = [];
Â  Â  Â  Â  const barCount = 40;
Â  Â  Â  Â  const barWidth = 8;
Â  Â  Â  Â  const waveY = canvas.height / 2;
Â  Â  Â  Â  let dataArray; 
Â  Â  Â  Â  
Â  Â  Â  Â  let animationFrameId;
Â  Â  Â  Â  let isSpeaking = false; 

Â  Â  Â  Â  function createBars() {
Â  Â  Â  Â  Â  Â  bars = [];
Â  Â  Â  Â  Â  Â  const startX = canvas.width / 2 - (barCount * barWidth) / 2;
Â  Â  Â  Â  Â  Â  for (let i = 0; i < barCount; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  bars.push({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  x: startX + i * barWidth,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  height: 10,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  color: "#00ffff"
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function drawBars() {
Â  Â  Â  Â  Â  Â  bars.forEach(bar => {
Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillStyle = bar.color;
Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillRect(bar.x, waveY - bar.height / 2, barWidth - 2, bar.height); 
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â 
Â  Â  Â  Â  function animateBars() {
Â  Â  Â  Â  Â  Â  ctx.clearRect(0, 0, canvas.width, canvas.height);

Â  Â  Â  Â  Â  Â  // analyserã¨dataArrayãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
Â  Â  Â  Â  Â  Â  if (isRecording && analyser && audioContext.state === 'running' && dataArray) {
Â  Â  Â  Â  Â  Â  Â  Â  analyser.getByteFrequencyData(dataArray);

Â  Â  Â  Â  Â  Â  Â  Â  const step = Math.floor(dataArray.length / barCount); 
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  bars.forEach((bar, i) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const volume = dataArray[i * step] / 255; 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let targetHeight = volume * 180 + 20; 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  bar.height += (targetHeight - bar.height) * 0.15;
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  } else if (isSpeaking) {
Â  Â  Â  Â  Â  Â  Â  Â  // èª­ã¿ä¸Šã’ä¸­ã®ãƒ­ã‚¸ãƒƒã‚¯
Â  Â  Â  Â  Â  Â  Â  Â  bars.forEach(bar => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let targetHeight = Math.random() * 80 + 20;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  bar.height += (targetHeight - bar.height) * 0.15;
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  // å¾…æ©Ÿä¸­ã®ãƒ­ã‚¸ãƒƒã‚¯
Â  Â  Â  Â  Â  Â  Â  Â  bars.forEach(bar => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let targetHeight = 10 + Math.random() * 10;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  bar.height += (targetHeight - bar.height) * 0.15;
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  drawBars();
Â  Â  Â  Â  Â  Â  animationFrameId = requestAnimationFrame(animateBars);
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- 2. éŸ³å£°èª­ã¿ä¸Šã’/èªè­˜/APIé€£æºé–¢é€£ ---
Â  Â  Â  Â  
Â  Â  Â  Â  // DOMè¦ç´ ã®å–å¾—
Â  Â  Â  Â  const statusArea = document.getElementById("status-area");
Â  Â  Â  Â  const sendBtn = document.getElementById("sendBtn"); 
Â  Â  Â  Â  const input = document.getElementById("messageInput"); 
Â  Â  Â  Â  const transcriptBox = document.getElementById('transcript');
Â  Â  Â  Â  const ui = document.getElementById('ui'); 
Â  Â  Â  Â  const tapArea = document.getElementById('tapArea'); 
Â  Â  Â  Â  
Â  Â  Â  Â  // APIè¨­å®š
Â  Â  Â  Â  const API_KEY = ""; 
Â  Â  Â  Â  const LLM_API_URL = "http://127.0.0.1:8001/generate";
Â  Â  Â  Â  const MQTT_API_URL = "http://127.0.0.1:8000/control"; 

Â  Â  Â  Â  // çŠ¶æ…‹ç®¡ç†å¤‰æ•°
Â  Â  Â  Â  const synth = window.speechSynthesis;
Â  Â  Â  Â  let utterance = null;
Â  Â  Â  Â  let currentTextToSpeak = ''; 
Â  Â  Â  Â  let audioContext, analyser, mediaStream;
Â  Â  Â  Â  let isRecording = false; 
Â  Â  Â  Â  let recognition = null; 

Â  Â  Â  Â  /* ---------- UI helpers ---------- */

Â  Â  Â  Â  function updateStatus(message, color = '#00ffff') {
Â  Â  Â  Â  Â  Â  statusArea.innerHTML = message; 
Â  Â  Â  Â  Â  Â  statusArea.style.color = color;
Â  Â  Â  Â  Â  Â  statusArea.style.boxShadow = `0 0 20px ${color}80`;
Â  Â  Â  Â  }

Â  Â  Â  Â  function setStandbyStatus() {
Â  Â  Â  Â  Â  Â  const standbyMsg = `
Â  Â  Â  Â  Â  Â  ã‚¤ãƒã‚¸ãƒŠãƒªãƒ¼ãƒŠãƒ³ãƒãƒ¼
Â  Â  Â  Â  Â  Â  é€šç§°GAIã‚¤ãƒã•ã‚“AI
Â  Â  Â  Â  Â  Â  AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆå¾…æ©Ÿä¸­...
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  updateStatus(standbyMsg.trim(), '#00ffff');
Â  Â  Â  Â  Â  Â  input.disabled = false; // å¾…æ©ŸçŠ¶æ…‹ã«æˆ»ã‚‹éš›ã«æœ‰åŠ¹åŒ–ã‚’ä¿è¨¼
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  /* ---------- Speech Recognition (Browser STT) & Audio Init ---------- */

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Web Speech APIã«ã‚ˆã‚‹éŸ³å£°èªè­˜ã‚’é–‹å§‹ã—ã¾ã™ã€‚
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function startBrowserRecognition() {
Â  Â  Â  Â  Â  Â  if (isRecording) return;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
Â  Â  Â  Â  Â  Â  Â  Â  updateStatus('Error: Speech Recognition not supported in this browser.', '#ff0000');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (recognition) {
Â  Â  Â  Â  Â  Â  Â  Â  recognition.stop();
Â  Â  Â  Â  Â  Â  Â  Â  recognition = null;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  recognition = new (window.webkitSpeechRecognition || window.SpeechRecognition)();
Â  Â  Â  Â  Â  Â  recognition.continuous = false; 
Â  Â  Â  Â  Â  Â  recognition.interimResults = true; 
Â  Â  Â  Â  Â  Â  recognition.lang = 'ja-JP';

Â  Â  Â  Â  Â  Â  recognition.onstart = () => {
Â  Â  Â  Â  Â  Â  Â  Â  isRecording = true;
Â  Â  Â  Â  Â  Â  Â  Â  isSpeaking = true; // éŒ²éŸ³ä¸­ã¯æ³¢å½¢ã‚’å‹•ã‹ã™
Â  Â  Â  Â  Â  Â  Â  Â  input.disabled = true; // âœ¨ èªè­˜é–‹å§‹æ™‚ã«å…¥åŠ›æ¬„ã‚’ç„¡åŠ¹åŒ–
Â  Â  Â  Â  Â  Â  Â  Â  updateStatus('Listening...', '#ffff00');
Â  Â  Â  Â  Â  Â  Â  Â  transcriptBox.textContent = 'è©±ã—ã‹ã‘ã¦ãã ã•ã„...';
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  recognition.onresult = (event) => {
Â  Â  Â  Â  Â  Â  Â  Â  let interimTranscript = '';
Â  Â  Â  Â  Â  Â  Â  Â  let finalTranscript = '';

Â  Â  Â  Â  Â  Â  Â  Â  for (let i = event.resultIndex; i < event.results.length; ++i) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (event.results[i].isFinal) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  finalTranscript += event.results[i][0].transcript;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  interimTranscript += event.results[i][0].transcript;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  // èªè­˜çµæœã‚’transcriptBoxã«è¡¨ç¤ºã—ã€å…¥åŠ›æ¬„ã«ã‚‚åæ˜ 
Â  Â  Â  Â  Â  Â  Â  Â  transcriptBox.textContent = finalTranscript || interimTranscript;
Â  Â  Â  Â  Â  Â  Â  Â  input.value = finalTranscript || interimTranscript; 
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  // ç™ºè©±çµ‚äº†ã¾ãŸã¯ã‚¨ãƒ©ãƒ¼æ™‚ã®è‡ªå‹•å†ã‚¹ã‚¿ãƒ¼ãƒˆãƒ­ã‚¸ãƒƒã‚¯
Â  Â  Â  Â  Â  Â  const restartRecognition = () => {
Â  Â  Â  Â  Â  Â  Â  Â  isRecording = false;
Â  Â  Â  Â  Â  Â  Â  Â  input.disabled = false; // âœ¨ èªè­˜å†é–‹ï¼ˆï¼å¾…æ©ŸçŠ¶æ…‹ï¼‰å‰ã«å…¥åŠ›æ¬„ã‚’æœ‰åŠ¹åŒ–
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  if (!synth.speaking) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setStandbyStatus();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  recognition.start();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (e.name !== 'InvalidStateError') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn('Recognition start failed:', e);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }, 500); 
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  recognition.onend = () => {
Â  Â  Â  Â  Â  Â  Â  Â  isRecording = false;
Â  Â  Â  Â  Â  Â  Â  Â  isSpeaking = false; 
Â  Â  Â  Â  Â  Â  Â  Â  input.disabled = false; // âœ¨ èªè­˜çµ‚äº†æ™‚ã«å…¥åŠ›æ¬„ã‚’æœ‰åŠ¹åŒ–
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  const finalPrompt = transcriptBox.textContent.trim();
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  if (finalPrompt && finalPrompt.length > 1 && !finalPrompt.startsWith("ã‚¤ãƒã‚¸ãƒŠãƒªãƒ¼ãƒŠãƒ³ãƒãƒ¼ é€šç§°GAIã‚¤ãƒã•ã‚“AIå¿œç­”:")) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateStatus('Processing response...', '#00ffaa');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // LLMå‡¦ç†ä¸­ã«STTãŒè‡ªå‹•ã§å†èµ·å‹•ã—ãªã„ã‚ˆã†ã«ã€.finallyã§restartRecognitionã‚’å‘¼ã¶
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  processRecognitionResult(finalPrompt).finally(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  input.value = ''; // å‡¦ç†å®Œäº†å¾Œã«å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  restartRecognition(); 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  transcriptBox.textContent = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  input.value = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  restartRecognition();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  recognition.onerror = (event) => {
Â  Â  Â  Â  Â  Â  Â  Â  isRecording = false;
Â  Â  Â  Â  Â  Â  Â  Â  isSpeaking = false;
Â  Â  Â  Â  Â  Â  Â  Â  input.disabled = false; // âœ¨ ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã«å…¥åŠ›æ¬„ã‚’æœ‰åŠ¹åŒ–
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Speech Recognition Error:', event.error);
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  if (event.error !== 'not-allowed' && event.error !== 'aborted') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  restartRecognition();
Â  Â  Â  Â  Â  Â  Â  Â  } else if (event.error === 'aborted') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  restartRecognition();
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateStatus('Error: Microphone permission denied or failed.', '#ff0000');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  recognition.start();
Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  console.warn('Initial recognition start failed:', e);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¦æ±‚ã—ã€AudioContextã€æ³¢å½¢åˆ†æã€ãŠã‚ˆã³STTã‚’è¨­å®šã™ã‚‹
Â  Â  Â  Â  Â */
Â  Â  Â  Â  async function initAudioAndSTT(){
Â  Â  Â  Â  Â  Â  if(analyser) {
Â  Â  Â  Â  Â  Â  Â  Â  startBrowserRecognition();
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  updateStatus('Requesting microphone access...');

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  audioContext = new (window.AudioContext || window.webkitAudioContext)();
Â  Â  Â  Â  Â  Â  Â  Â  analyser = audioContext.createAnalyser();
Â  Â  Â  Â  Â  Â  Â  Â  analyser.fftSize = 2048;
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  // dataArrayã‚’ã“ã“ã§åˆæœŸåŒ–
Â  Â  Â  Â  Â  Â  Â  Â  dataArray = new Uint8Array(analyser.frequencyBinCount);
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
Â  Â  Â  Â  Â  Â  Â  Â  const sourceNode = audioContext.createMediaStreamSource(mediaStream);
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  sourceNode.connect(analyser);

Â  Â  Â  Â  Â  Â  Â  Â  startBrowserRecognition();

Â  Â  Â  Â  Â  Â  Â  Â  updateStatus('Listening...', '#ffff00');
Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Audio initialization failed:', e);
Â  Â  Â  Â  Â  Â  Â  Â  updateStatus('Error: Microphone access denied or failed to initialize.', '#ff0000');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * FastAPI/MQTTãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«ã‚³ãƒãƒ³ãƒ‰ã‚’é€ä¿¡ã™ã‚‹é–¢æ•°
Â  Â  Â  Â  Â */
Â  Â  Â  Â  async function sendIoTCommand(command) {
Â  Â  Â  Â  Â  Â  updateStatus(`Executing IoT command: ${command}...`, '#00ffaa');
Â  Â  Â  Â  Â  Â  transcriptBox.textContent = `IoTã‚³ãƒãƒ³ãƒ‰: ${command} ã‚’å®Ÿè¡Œä¸­...`;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(MQTT_API_URL, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ command: command })
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  const data = await response.json();

Â  Â  Â  Â  Â  Â  Â  Â  if (response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const successMsg = `æ‰¿çŸ¥ã—ã¾ã—ãŸã€‚${command === 'ON' ? 'é›»æ°—ã‚’ã¤ã‘ã¾ã—ãŸ' : 'é›»æ°—ã‚’æ¶ˆã—ã¾ã—ãŸ'}ã€‚`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  speak(successMsg);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const detail = data.detail || "ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const errorMsg = `ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚IoTã‚³ãƒãƒ³ãƒ‰ '${command}' ã®å®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸã€‚è©³ç´°: ${detail}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  speak(errorMsg);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  const networkErrorMsg = `ğŸ”´ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: IoTãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“ (${error.message})`;
Â  Â  Â  Â  Â  Â  Â  Â  speak(networkErrorMsg);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }


Â  Â  Â  Â  /* ---------- çµ±åˆã•ã‚ŒãŸãƒ¡ã‚¤ãƒ³å‡¦ç†é–¢æ•° (IoT or LLM) ---------- */

Â  Â  Â  Â  async function processRecognitionResult(finalPrompt) {
Â  Â  Â  Â  Â  Â  // 1. IoTã‚³ãƒãƒ³ãƒ‰ã®åˆ¤å®šã¨æŒ¯ã‚Šåˆ†ã‘
Â  Â  Â  Â  Â  Â  const lowerPrompt = finalPrompt.toLowerCase();
Â  Â  Â  Â  Â  Â  let iotCommand = null;

Â  Â  Â  Â  Â  Â  if ((lowerPrompt.includes('ãƒ©ã‚¤ãƒˆ') || lowerPrompt.includes('é›»æ°—')) && (lowerPrompt.includes('ã¤ã‘') || lowerPrompt.includes('ã‚ªãƒ³') || lowerPrompt.includes('ç‚¹ã‘'))) {
Â  Â  Â  Â  Â  Â  Â  Â  iotCommand = 'ON';
Â  Â  Â  Â  Â  Â  } else if ((lowerPrompt.includes('ãƒ©ã‚¤ãƒˆ') || lowerPrompt.includes('é›»æ°—')) && (lowerPrompt.includes('ã‘ã—') || lowerPrompt.includes('ã‚ªãƒ•') || lowerPrompt.includes('æ¶ˆã—'))) {
Â  Â  Â  Â  Â  Â  Â  Â  iotCommand = 'OFF';
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (iotCommand) {
Â  Â  Â  Â  Â  Â  Â  Â  await sendIoTCommand(iotCommand);
Â  Â  Â  Â  Â  Â  Â  Â  return; 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // 2. LLMå¿œç­”ç”Ÿæˆï¼ˆIoTã‚³ãƒãƒ³ãƒ‰ã§ãªã‹ã£ãŸå ´åˆï¼‰
Â  Â  Â  Â  Â  Â  await generateAndSpeakResponse(finalPrompt);
Â  Â  Â  Â  }


Â  Â  Â  Â  /* ---------- LLM (Gemini) API & TTS é€£æº ---------- */
Â  Â  Â  Â  async function generateAndSpeakResponse(prompt) {
Â  Â  Â  Â  Â  Â  updateStatus('Generating response (via FastAPI)...', '#00ffaa');
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const cleanedPrompt = prompt.replace(/^ã‚¤ãƒã‚¸ãƒŠãƒªãƒ¼ãƒŠãƒ³ãƒãƒ¼ é€šç§°GAIã‚¤ãƒã•ã‚“AIå¿œç­”:\s*/, '').trim();
Â  Â  Â  Â  Â  Â  if (!cleanedPrompt) {
Â  Â  Â  Â  Â  Â  Â  Â  return; 
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const systemInstruction = "ã‚ãªãŸã¯ã€Œã‚¤ãƒã‚¸ãƒŠãƒªãƒ¼ãƒŠãƒ³ãƒãƒ¼ é€šç§°GAIã‚¤ãƒã•ã‚“ã€ã¨ã„ã†åå‰ã®KS-903model8800-a1-90dã¨ã„ã†éŸ³å£°ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã«æ—¥æœ¬èªã§ã€ç°¡æ½”ã‹ã¤ä¸å¯§ã«ç­”ãˆã¦ãã ã•ã„ã€‚";

Â  Â  Â  Â  Â  Â  const payload = {
Â  Â  Â  Â  Â  Â  Â  Â  prompt: cleanedPrompt,
Â  Â  Â  Â  Â  Â  Â  Â  contents: [{ parts: [{ text: cleanedPrompt }] }],
Â  Â  Â  Â  Â  Â  Â  Â  systemInstruction: { parts: [{ text: systemInstruction }] },
Â  Â  Â  Â  Â  Â  Â  Â  tools: [{ "google_search": {} }], 
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const MAX_RETRIES = 3;
Â  Â  Â  Â  Â  Â  let responseText = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚¤ãƒã‚¸ãƒŠãƒªãƒ¼ãƒŠãƒ³ãƒãƒ¼ é€šç§°GAIã‚¤ãƒã•ã‚“AIã®KS-903model8800-a1-90då¿œç­”ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚";

Â  Â  Â  Â  Â  Â  for (let i = 0; i < MAX_RETRIES; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(LLM_API_URL, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify(payload)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const errorData = await response.json().catch(() => ({ detail: `HTTP ${response.status} Error.` }));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(`FastAPI Error! Status: ${response.status}. Detail: ${errorData.detail}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const result = await response.json();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (result && result.text) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  responseText = result.text;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break; 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â throw new Error("Empty response or invalid JSON structure from FastAPI.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error(`FastAPI call error on attempt ${i + 1}:`, e);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (i === MAX_RETRIES - 1) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  responseText = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚¤ãƒã‚¸ãƒŠãƒªãƒ¼ãƒŠãƒ³ãƒãƒ¼ é€šç§°GAIã‚¤ãƒã•ã‚“AIKS-903model8800-a1-90dã®å¿œç­”ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚Generaltebãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒãƒ¼ (ãƒãƒ¼ãƒˆ8001) ã®å®Ÿè¡ŒçŠ¶æ…‹ã¨APIã‚­ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const delay = 2 ** i * 1000 + Math.random() * 500;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await new Promise(resolve => setTimeout(resolve, delay));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  updateStatus('Speaking response...', '#00ffaa');
Â  Â  Â  Â  Â  Â  speak(responseText); 
Â  Â  Â  Â  }

Â  Â  Â  Â  /* ---------- TTS (Speech Synthesis) ---------- */

Â  Â  Â  Â  function speak(text){ 
Â  Â  Â  Â  Â  Â  if(!text) return; 
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if(synth.speaking) synth.cancel(); 
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  transcriptBox.textContent = "ã‚¤ãƒã‚¸ãƒŠãƒªãƒ¼ãƒŠãƒ³ãƒãƒ¼ é€šç§°GAIã‚¤ãƒã•ã‚“AIå¿œç­”: " + text;
Â  Â  Â  Â  Â  Â  isSpeaking = true; // æ³¢å½¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹

Â  Â  Â  Â  Â  Â  const u = new SpeechSynthesisUtterance(text); 
Â  Â  Â  Â  Â  Â  u.lang='ja-JP'; 
Â  Â  Â  Â  Â  Â  u.rate=1.0; 
Â  Â  Â  Â  Â  Â  u.onstart=()=>{ 
Â  Â  Â  Â  Â  Â  Â  Â  const display = text.length > 20 ? text.substring(0, 20) + '...' : text;
Â  Â  Â  Â  Â  Â  Â  Â  const formattedStatus = `
Â  Â  Â  Â  Â  Â  ã‚¤ãƒã‚¸ãƒŠãƒªãƒ¼ãƒŠãƒ³ãƒãƒ¼
Â  Â  Â  Â  Â  Â  é€šç§°GAIã‚¤ãƒã•ã‚“AIå¿œç­”
Â  Â  Â  Â  Â  Â  ã€Œ${display}ã€
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  updateStatus(formattedStatus.trim(), '#00ffaa');
Â  Â  Â  Â  Â  Â  }; 
Â  Â  Â  Â  Â  Â  u.onend=()=>{ 
Â  Â  Â  Â  Â  Â  Â  Â  isSpeaking = false; // æ³¢å½¢ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åœæ­¢
Â  Â  Â  Â  Â  Â  Â  Â  // èª­ã¿ä¸Šã’çµ‚äº†å¾Œã€STTãŒè‡ªå‹•ã§å†ã‚¹ã‚¿ãƒ¼ãƒˆã™ã‚‹ãŸã‚ã€ã“ã“ã§ã¯å¾…æ©ŸçŠ¶æ…‹ã«æˆ»ã•ãªã„ (STTã®onendã«ä»»ã›ã‚‹)
Â  Â  Â  Â  Â  Â  Â  Â  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã®æ›´æ–°ã®ã¿è¡Œã† (å¾…æ©ŸçŠ¶æ…‹ã«æˆ»ã‚‹ã“ã¨ã‚’ç¤ºå”†)
Â  Â  Â  Â  Â  Â  Â  Â  const formattedStatus = (
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  "Â  ã‚¤ãƒã‚¸ãƒŠãƒªãƒ¼ãƒŠãƒ³ãƒãƒ¼Â  Â <br>" +
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  "Â  é€šç§°GAIã‚¤ãƒã•ã‚“Â  AI <br>" +
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  "ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆå¾…æ©Ÿä¸­..."
Â  Â  Â  Â  Â  Â  Â  Â  );

Â  Â  Â  Â  Â  Â  Â  Â  updateStatus(formattedStatus);
Â  Â  Â  Â  Â  Â  }; 
Â  Â  Â  Â  Â  Â  u.onerror = (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('TTS error:', e);
Â  Â  Â  Â  Â  Â  Â  Â  isSpeaking = false;
Â  Â  Â  Â  Â  Â  Â  Â  setStandbyStatus();
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  synth.speak(u); 
Â  Â  Â  Â  }

Â  Â  Â  Â  /* ---------- ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã®çµ±åˆã¨å®šç¾© ---------- */

Â  Â  Â  Â  // ã€âœ¨ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã€‘
Â  Â  Â  Â  input.addEventListener('keypress', (event) => {
Â  Â  Â  Â  Â  Â  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒEnterã‚­ãƒ¼ã‚’æŠ¼ã—ãŸã“ã¨ã‚’æ¤œå‡º
Â  Â  Â  Â  Â  Â  if (event.key === 'Enter') {
Â  Â  Â  Â  Â  Â  Â  Â  const textPrompt = input.value.trim();
Â  Â  Â  Â  Â  Â  Â  Â  if (textPrompt) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // ãƒã‚¤ã‚¯å…¥åŠ›ã‚’ä¸€æ™‚åœæ­¢ (è¡çªé˜²æ­¢)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (recognition && isRecording) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  recognition.stop(); // STTã‚’å¼·åˆ¶çµ‚äº†
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isRecording = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateStatus('Text input received. Processing...', '#ffff00');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  transcriptBox.textContent = 'å…¥åŠ›ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã‚’å‡¦ç†ä¸­...';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // LLM/IoTå‡¦ç†ã‚’å®Ÿè¡Œ
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  processRecognitionResult(textPrompt).finally(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // å‡¦ç†ãŒçµ‚ã‚ã£ãŸã‚‰ã€ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  input.value = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // éŸ³å£°èªè­˜ã‚’å†é–‹
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(startBrowserRecognition, 1000);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });


Â  Â  Â  Â  // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã®æ©Ÿèƒ½ (STTã¨TTSã®å¼·åˆ¶åœæ­¢ã¨å†èµ·å‹•)
Â  Â  Â  Â  sendBtn.addEventListener("click", () => {
Â  Â  Â  Â  Â  Â  if (recognition) {
Â  Â  Â  Â  Â  Â  Â  Â  recognition.stop();
Â  Â  Â  Â  Â  Â  Â  Â  recognition = null;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if(synth.speaking) synth.cancel(); 

Â  Â  Â  Â  Â  Â  transcriptBox.textContent='ãƒªã‚»ãƒƒãƒˆä¸­...'; 
Â  Â  Â  Â  Â  Â  input.value = ''; // ãƒªã‚»ãƒƒãƒˆæ™‚ã«å…¥åŠ›æ¬„ã‚‚ã‚¯ãƒªã‚¢
Â  Â  Â  Â  Â  Â  input.disabled = false; // âœ¨ ãƒªã‚»ãƒƒãƒˆæ™‚ã«å…¥åŠ›æ¬„ã‚’æœ‰åŠ¹åŒ–
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  initAudioAndSTT();
Â  Â  Â  Â  Â  Â  updateStatus('ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚ãƒã‚¤ã‚¯å…¥åŠ›ã‚’é–‹å§‹ã—ã¦ã„ã¾ã™...'); 
Â  Â  Â  Â  });


Â  Â  Â  Â  // UI ãƒˆã‚°ãƒ«æ©Ÿèƒ½ (ç”»é¢ã‚¿ãƒƒãƒ—) ã®ä¿®æ­£
Â  Â  Â  Â  let uiVisible = true; // åˆæœŸçŠ¶æ…‹ã‚’å¯è¦–ã«å¤‰æ›´
Â  Â  Â  Â  tapArea.addEventListener('click', (e) => {
Â  Â  Â  Â  Â  Â  // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³/å…¥åŠ›æ¬„ã¸ã®ã‚¿ãƒƒãƒ—ã¯ç„¡è¦–
Â  Â  Â  Â  Â  Â  if (e.target.closest('#input-controls')) {
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  uiVisible = !uiVisible;
Â  Â  Â  Â  Â  Â  if (uiVisible) {
Â  Â  Â  Â  Â  Â  Â  Â  ui.style.opacity = 1; 
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  ui.style.opacity = 0; 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  /* ---------- Start-up ---------- */
Â  Â  Â  Â  window.onload = function() {
Â  Â  Â  Â  Â  Â  createBars();
Â  Â  Â  Â  Â  Â  animateBars();
Â  Â  Â  Â  Â  Â  initAudioAndSTT(); // ãƒã‚¤ã‚¯åˆæœŸåŒ–ã¨STTã‚’è‡ªå‹•ã§é–‹å§‹
Â  Â  Â  Â  Â  Â  setStandbyStatus();
Â  Â  Â  Â  Â  Â  input.focus(); // èµ·å‹•æ™‚ã«å…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
Â  Â  Â  Â  }
Â  Â  </script>
</body>
</html>